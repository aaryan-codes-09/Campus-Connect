{% extends 'base.html' %}
{% block title %}Notices – CampusConnect{% endblock %}
{% block page_title %}Notice Board{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-3">
  <div>
    <div class="page-header-title"><i class="fas fa-bell me-2 text-teal"></i>Notice Board</div>
    <div class="page-header-sub">
      {% if current_user.role == 'student' %}Showing notices addressed to you ({{ current_user.department }} · {{ current_user.year }})
      {% else %}All notices — post to specific departments and years{% endif %}
    </div>
  </div>
  {% if current_user.role in ('teacher','organizer','admin') %}
  <a href="/notices/create" class="btn btn-teal"><i class="fas fa-plus me-2"></i>Post Notice</a>
  {% endif %}
</div>
<div class="page-content">
  <!-- Category filter -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="/notices" class="badge-pill {{ 'badge-teal' if not cat_filter else 'badge-muted' }}" style="cursor:pointer;font-size:.8rem;padding:.35rem .8rem">All</a>
    {% for cat,col in [('academic','blue'),('placement','amber'),('finance','coral'),('sports','teal'),('cultural','purple'),('general','muted')] %}
    <a href="/notices?cat={{ cat }}" class="badge-pill badge-{{ col }}" style="cursor:pointer;font-size:.8rem;padding:.35rem .8rem;{{ 'opacity:.5' if cat_filter and cat_filter!=cat }}">{{ cat|title }}</a>
    {% endfor %}
  </div>

  <div class="d-flex flex-column gap-3">
    {% for n in notices %}
    <div class="notice-item {{ 'important' if n.is_important else n.category }}" style="transition:border-color .2s">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
        <div style="flex:1">
          <div class="d-flex gap-2 mb-2 flex-wrap">
            {% if n.is_important %}<span class="badge-pill badge-coral" style="font-size:.65rem">⚠ IMPORTANT</span>{% endif %}
            <span class="badge-pill badge-muted" style="font-size:.65rem">{{ n.category|title }}</span>
            {% if n.department != 'All' %}<span class="badge-pill badge-blue" style="font-size:.65rem">{{ n.department[:15] }}</span>{% endif %}
            {% if n.year != 'All' %}<span class="badge-pill badge-amber" style="font-size:.65rem">{{ n.year }}</span>{% endif %}
          </div>
          <div class="notice-item-title" style="font-size:.95rem;margin-bottom:6px">{{ n.title }}</div>
          {% if n.content %}<div style="color:var(--c-muted);font-size:.85rem;line-height:1.6;margin-bottom:8px">{{ n.content }}</div>{% endif %}
          <div class="notice-item-meta">
            <span><i class="fas fa-user me-1"></i>{{ n.author_name }} ({{ n.author_role|title }})</span>
            <span><i class="fas fa-clock me-1"></i>{{ n.created_at[:10] }}</span>
            <span><i class="fas fa-users me-1"></i>For: {{ n.department }} · {{ n.year }}</span>
          </div>
        </div>
        <!-- WhatsApp Share button -->
        {% if n.whatsapp_message %}
        <div class="d-flex flex-column gap-2 align-items-end" style="flex-shrink:0">
          <a href="https://wa.me/?text={{ n.whatsapp_message|urlencode }}" target="_blank"
             class="btn btn-sm" style="background:#25d366;color:white;border-radius:8px;white-space:nowrap;font-size:.78rem">
            <i class="fab fa-whatsapp me-1" style="font-size:.9rem"></i>Share on WhatsApp
          </a>
          <button class="btn btn-ghost btn-sm" onclick="copyWA('{{ loop.index }}')" style="font-size:.75rem">
            <i class="fas fa-copy me-1"></i>Copy Message
          </button>
          <textarea id="wa-{{ loop.index }}" style="display:none">{{ n.whatsapp_message }}</textarea>
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div style="padding:48px;text-align:center;color:var(--c-muted)">
      <i class="fas fa-bell-slash" style="font-size:2.5rem;opacity:.3;margin-bottom:12px;display:block"></i>
      <h5>No notices found.</h5>
      {% if current_user.role == 'student' %}<p style="font-size:.85rem">No notices addressed to your department/year yet.</p>{% endif %}
    </div>
    {% endfor %}
  </div>
</div>
<script>
function copyWA(idx) {
  const ta = document.getElementById('wa-' + idx);
  navigator.clipboard.writeText(ta.value).then(() => {
    alert('WhatsApp message copied! Paste it in any WhatsApp group.');
  });
}
</script>
{% endblock %}
