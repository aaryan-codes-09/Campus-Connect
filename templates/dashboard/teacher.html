{% extends 'base.html' %}
{% block title %}Teacher Dashboard ‚Äì CampusConnect{% endblock %}
{% block page_title %}Teacher Dashboard{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-3">
  <div>
    <div class="page-header-title">{{ current_user.full_name }} <span style="font-size:1rem;opacity:.6">üë©‚Äçüè´</span></div>
    <div class="page-header-sub">
      <span class="badge-pill badge-amber me-2">Teacher</span>
      <span class="badge-pill badge-muted">{{ current_user.department }}</span>
    </div>
  </div>
  <a href="/attendance/create" class="btn btn-teal"><i class="fas fa-qrcode me-2"></i>Start QR Session</a>
</div>

<div class="page-content">
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4"><div class="stat-card"><div class="stat-icon stat-icon-teal"><i class="fas fa-qrcode"></i></div><div><div class="stat-num">{{ stats.my_sessions }}</div><div class="stat-label">Total Sessions</div></div></div></div>
    <div class="col-6 col-md-4"><div class="stat-card"><div class="stat-icon stat-icon-amber"><i class="fas fa-users"></i></div><div><div class="stat-num">{{ stats.total_students }}</div><div class="stat-label">My Students</div></div></div></div>
    <div class="col-6 col-md-4"><div class="stat-card"><div class="stat-icon stat-icon-coral"><i class="fas fa-calendar-day"></i></div><div><div class="stat-num">{{ stats.today_sessions }}</div><div class="stat-label">Today's Sessions</div></div></div></div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <!-- Student Attendance Summary -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="card-header-title"><i class="fas fa-users"></i>Student Attendance Summary</div>
          <a href="/attendance" class="btn btn-ghost btn-sm">Full Report</a>
        </div>
        <div class="card-body p-0">
          {% if my_students %}
          <div class="table-responsive">
            <table class="table mb-0">
              <thead><tr><th>Student</th><th>Roll No.</th><th>Year</th><th>Sessions Attended</th><th>Status</th></tr></thead>
              <tbody>
                {% for s in my_students[:15] %}
                <tr>
                  <td>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div class="avatar avatar-teal" style="width:28px;height:28px;font-size:.72rem;flex-shrink:0">{{ s.full_name[0] }}</div>
                      <span style="font-weight:600;font-size:.85rem">{{ s.full_name }}</span>
                    </div>
                  </td>
                  <td><span style="font-size:.8rem;color:var(--c-muted)">{{ s.roll_number or 'N/A' }}</span></td>
                  <td><span class="badge-pill badge-muted">{{ s.year or 'N/A' }}</span></td>
                  <td>
                    <div style="display:flex;align-items:center;gap:8px">
                      <span style="font-weight:600;font-size:.88rem">{{ s.att_count }}</span>
                      <div style="flex:1;height:5px;background:var(--c-border);border-radius:3px;min-width:60px">
                        <div style="height:5px;background:var(--c-teal);border-radius:3px;width:{{ [100, (s.att_count * 10)|int]|min }}%"></div>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge-pill {{ 'badge-teal' if s.att_count >= 5 else 'badge-amber' if s.att_count >= 2 else 'badge-coral' }}">{{ 'Good' if s.att_count >= 5 else 'Average' if s.att_count >= 2 else 'Low' }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div style="padding:28px;text-align:center;color:var(--c-muted)"><i class="fas fa-users" style="font-size:2rem;opacity:.3;margin-bottom:8px;display:block"></i>No students in your department yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Recent Attendance Entries -->
      <div class="card">
        <div class="card-header"><div class="card-header-title"><i class="fas fa-history"></i>Recent Attendance Records</div></div>
        <div class="card-body p-0">
          {% if recent_att %}
          <table class="table mb-0">
            <thead><tr><th>Student</th><th>Subject</th><th>Date</th><th>Time</th></tr></thead>
            <tbody>
              {% for r in recent_att[:10] %}
              <tr>
                <td style="font-weight:600;font-size:.85rem">{{ r.student_name }}</td>
                <td><span class="badge-pill badge-teal">{{ r.subject }}</span></td>
                <td><span style="font-size:.8rem;color:var(--c-muted)">{{ r.date }}</span></td>
                <td><span style="font-size:.78rem;color:var(--c-muted)">{{ r.marked_at[11:16] }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div style="padding:20px;text-align:center;color:var(--c-muted);font-size:.85rem">No attendance records yet. Start a QR session!</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- My Sessions -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="card-header-title"><i class="fas fa-qrcode"></i>Recent Sessions</div>
          <a href="/attendance/create" class="btn btn-teal btn-sm">+ New</a>
        </div>
        <div class="card-body">
          {% if sessions %}
          <div class="d-flex flex-column gap-2">
            {% for s in sessions[:6] %}
            <a href="/attendance/session/{{ s.id }}" style="background:var(--c-surface);border:1px solid var(--c-border);border-radius:9px;padding:10px 12px;text-decoration:none;display:block;transition:border-color .2s" onmouseover="this.style.borderColor='var(--c-teal)'" onmouseout="this.style.borderColor='var(--c-border)'">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <span style="font-weight:600;font-size:.85rem;color:var(--c-text)">{{ s.subject }}</span>
                <span class="badge-pill {{ 'badge-teal' if s.is_active else 'badge-muted' }}" style="font-size:.62rem">{{ 'LIVE' if s.is_active else 'Closed' }}</span>
              </div>
              <div style="font-size:.75rem;color:var(--c-muted);margin-top:4px"><i class="fas fa-users me-1"></i>{{ s.present_count or 0 }} present &nbsp;¬∑&nbsp; {{ s.date }}</div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div style="text-align:center;color:var(--c-muted);font-size:.85rem;padding:16px">No sessions yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card mb-4">
        <div class="card-header"><div class="card-header-title"><i class="fas fa-bolt"></i>Quick Actions</div></div>
        <div class="card-body d-flex flex-column gap-2">
          <a href="/attendance/create" class="btn btn-teal w-100 text-start"><i class="fas fa-qrcode me-2"></i>Create QR Session</a>
          <a href="/timetable/manage" class="btn btn-ghost w-100 text-start"><i class="fas fa-edit me-2"></i>Manage Timetable</a>
          <a href="/notices/create" class="btn btn-ghost w-100 text-start"><i class="fas fa-bullhorn me-2"></i>Post Notice</a>
        </div>
      </div>

      <!-- My Info -->
      <div class="card" style="color : white">
        <div class="card-header"><div class="card-header-title"><i class="fas fa-info-circle"></i>My Info</div></div>
        <div class="card-body" style="font-size:.85rem">
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;justify-content:space-between"><span style="color:var(--c-muted)">Name</span><strong style="text-align:right;max-width:60%">{{ current_user.full_name }}</strong></div>
            <div class="divider" style="margin:0"></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--c-muted)">Department</span><strong style="text-align:right;max-width:60%">{{ (current_user.department or 'N/A')[:25] }}</strong></div>
            <div class="divider" style="margin:0"></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--c-muted)">Role</span><strong>Teacher</strong></div>
            <div class="divider" style="margin:0"></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--c-muted)">Email</span><strong style="font-size:.8rem;text-align:right;max-width:60%">{{ current_user.email }}</strong></div>
          </div>
          <a href="/profile/edit" class="btn btn-ghost btn-sm w-100 mt-3">Edit Profile</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
